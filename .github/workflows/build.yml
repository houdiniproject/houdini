
name: Main build
on: 
  pull_request:
    types: [opened, reopened, synchronize]
  push:
    branches: ["supporter_level_goal"]
concurrency: 
  group: build--${{ github.head_ref || github.ref }}
  cancel-in-progress: true
jobs:
  build:
      env:
        CUSTOM_RUBY_VERSION: ${{ matrix.ruby }}
      runs-on: ${{ matrix.os }}
      strategy:
        matrix:
          os: [ubuntu-20.04, ubuntu-22.04, ubuntu-24.04]
          node: [16]
          ruby: ['2.6.10']
          postgres: ['16']
        fail-fast: false
      steps:
        - uses: actions/checkout@v4
        - uses: dorny/paths-filter@v3
          id: changes
          with:
            filters: |
              ruby:
                - 'app/**'
                - 'bin/**'
                - 'config/**'
                - 'db/**'
                - 'gems/**'
                - 'lib/**'
                - 'public/**'
                - 'script/**'
                - 'spec/**'
                - '.ruby-version'
                - '.rspec'
                - 'config.ru'
                - 'Gemfile'
                - 'Gemfile.lock'
                - 'Rakefile'
              js:
                - '**/*.js*'
                - '**/*.es6'
                - '**/*.ts*'
                - '**/*.json'
                - package.json
                - yarn.lock
                - '.nvmrc'
                - '.babelrc'
                - '.bootstraprc'
                - '.browserlistrc'
              
        - name: Setup PostgreSQL with PostgreSQL extensions and unprivileged user
          uses: Daniel-Marynicz/postgresql-action@1.0.0
          with:
            postgres_image_tag: ${{ matrix.postgres }}-alpine
            postgres_user: admin
            postgres_password: password
        - uses: actions/setup-node@v4
          with:
            node-version: ${{ matrix.node }}
            cache: 'yarn'
        - uses: ruby/setup-ruby@v1
          with:
            ruby-version: ${{ matrix.ruby }}
            bundler-cache: true
      
        - run: bin/setup
        - continue-on-error: true
          if: steps.changes.outputs.ruby == 'true'
          name: run spec
          run: bin/rake spec
        - continue-on-error: true
          if: steps.changes.outputs.ruby == 'true'
          run: script/compile-assets.sh
        - continue-on-error: true
          if: steps.changes.outputs.js == 'true'
          run: yarn build
        - continue-on-error: true
          if: steps.changes.outputs.js == 'true'
          run: yarn jest
