sudo: required

language: minimal

services:
  - docker

before_script:
  - mkdir -p ~/docker-images
  - "if [[ -f ~/docker-images/testenv.tgz ]]; then  docker load -i ~/docker-images/testenv.tgz; fi "
  - cp .env.test .env
  - docker-compose -f docker/build/docker-compose.yml build
  - docker save test.image.for.caching | gzip -c > ~/docker-images/testenv.tgz

script:
  - docker-compose -f docker/build/docker-compose.yml run -e RACK_ENV=ci -e RAILS_ENV=ci -e BUILD_DATABASE_URL=postgres://admin:password@db/commitchange_development build script/test.sh

cache:
  directories: 
    ~/docker-images
