# Flow of funds in Destination Charges

## Charge

`Stripe::Charge.create({amount:1000, on_behalf_of: "acct",application_fee_amount: 81})`

```text

 (3.5% Stripe fee, 3% platform fee)
                +----------------------------------+                      +----------------------------------+
                |                                  |                      |                                  |
                |         Platform Account         |                      |          Connected Account       |
                | +-----------------------------+  |                      |                                  |
+----------------->          $10 charge         |  |                      |                                  |
                | +-------------+---------------+  |                      |                                  |
                |               |                  |                      |                                  |
                |               |                  |                      |                                  |
                |               |                  |                      |                                  |
                |               v                  |                      |                                  |
                | +-------------+----------------+ |                      |   +-------------------------+    |
                | |        $10 transfer          +--------------------------->+        $10 payment      |    |
                | +------------------------------+ |                      |   +-----------+-------------+    |
                |                                  |                      |               |                  |
                |                                  |                      |               v                  |
                | +------------------------------+ |                      |   +-----------+--------------+   |
                | |                              | |                      |   |                          |   |
                | | $0.65 Application Fee        +<---------------------------+ ($0.65) Application Fee  |   |
                | |                              | |                      |   |                          |   |
                | +------------+-----------------+ |                      |   +------------+-------------+   |
                |              |                   |                      |                |                 |
                |              v                   |                      |                v                 |
                | +------------+----------------+  |                      |   +------------+-------------+   |
                | |                             |  |                      |   |                          |   |
                | |   ($0.35) Stripe fee        |  |                      |   |      $9.35 net           |   |
                | |                             |  |                      |   |                          |   |
                | +------------+----------------+  |                      |   +--------------------------+   |
                |              |                   |                      |                                  |
                |              v                   |                      |                                  |
                | +------------+----------------+  |                      |                                  |
                | |                             |  |                      |                                  |
                | |     $0.30 net               |  |                      |                                  |
                | |                             |  |                      |                                  |
                | +-----------------------------+  |                      |                                  |
                |                                  |                      |                                  |
                |                                  |                      +----------------------------------+
                +----------------------------------+

```

## Refunds

(These descriptions don't use the correct objects totally but are functionally accurate)

### Old refund Flow

```text
           Stripe::Refund.create({id: 'charge_id', amount:500, refund_application_fee: true, reverse_transfer: true})



            (3.5% Stripe fee, 3% platform fee)
           +----------------------------------+                      +----------------------------------+
           |                                  |                      |                                  |
           |         Platform Account         |                      |          Connected Account       |
           | +-----------------------------+  |                      |                                  |
<------------+          $5 refund          |  |                      |                                  |
           | +-------------+---------------+  |                      |                                  |
           |               |                  |                      |                                  |
           |               |                  |                      |                                  |
           |               |                  |                      |                                  |
           |               v                  |                      |                                  |
           | +-------------+----------------+ |                      |   +-------------------------+    |
           | |         $5 transfer          +<---------------------------+         ($5) refund     |    |
           | +------------------------------+ |                      |   +-----------+-------------+    |
           |                                  |                      |               |                  |
           |                                  |                      |               |                  |
           | +------------------------------+ |                      |   +-----------+--------------+   |
           | |                              | |                      |   |                          |   |
           | | ($0.15) transfer             +--------------------------->+  $0.15 app fee refund    |   |
           | |                              | |                      |   |                          |   |
           | +--------------+---------------+ |                      |   +------------+-------------+   |
           |                |                 |                      |                |                 |
           |                |                 |                      |                v                 |
           |                |                 |                      |   +------------+-------------+   |
           |                |                 |                      |   |                          |   |
           |                v                 |                      |   |      ($4.69 net)         |   |
           | +--------------+--------------+  |                      |   |                          |   |
           | |                             |  |                      |   +------------+-------------+   |
           | |                             |  |                      |                ^                 |
           | |        ($0.15 net)          |  |                      |                |                 |
           | |                             |  |                      |   +------------+--------------+  |
           | +-----------------------------+  |                      |   | $0.17 stripe fee refunds  |  |
           |                                  |                      |   |                           |  |
           |                                  |                      |   +---------------------------+  |
           |                                  |                      |                                  |
           |                                  |                      |                                  |
           |                                  |                      +----------------------------------+
           +----------------------------------+
```

### New refund process

Consists of two calls: *Refund* and *Application Fee Reversal*.

#### Refund

`refund = Stripe::Refund.create({charge: 'charge_id', amount:500, reverse_transfer: true, expand: ['charge']}, {stripe_version: '2019-09-09'})`

```text
            (3.5% Stripe fee, 3% platform fee)
           +----------------------------------+                      +----------------------------------+
           |                                  |                      |                                  |
           |         Platform Account         |                      |          Connected Account       |
           | +-----------------------------+  |                      |                                  |
<------------+          $5 refund          |  |                      |                                  |
           | +-------------+---------------+  |                      |                                  |
           |               |                  |                      |                                  |
           |               |                  |                      |                                  |
           |               |                  |                      |                                  |
           |               v                  |                      |                                  |
           | +-------------+----------------+ |                      |   +-------------------------+    |
           | |         $5 transfer          +<---------------------------+         $5  refund      |    |
           | +--------------+---------------+ |                      |   +------------+------------+    |
           |                |                 |                      |                |                 |
           |                v                 |                      |                v                 |
           | +--------------+---------------+ |                      |   +------------+------------+    |
           | |        $0 net                | |                      |   |      ($5) net           |    |
           | +------------------------------+ |                      |   +-------------------------+    |
           +----------------------------------+                      +----------------------------------+
```

#### Application Fee Reversal

```ruby
Stripe::ApplicationFee.create_refund({id: refund.charge.application_fee, amount: (500 * 0.03).round}, {stripe_version: '2019-09-09})
                                                                           # (BigNumber(amount of refund) * BigNumber(platform_fee)).round
```

```text

  (3.5% Stripe fee, 3% platform fee)
                                                            +----------------------------------+
  +----------------------------------+                      |                                  |
  |                                  |                      |          Connected Account       |
  |          Platform account        |                      |                                  |
  |   +--------------------------+   |                      |  +----------------------------+  |
  |   | ($0.15) application fee  +---------------------------->+  $0.15 transfer            |  |
  |   |           refund         |   |                      |  +------------+---------------+  |
  |   +-----------+--------------+   |                      |               |                  |
  |               |                  |                      |               v                  |
  |               v                  |                      |   +-----------+-------------+    |
  |   +-----------+---------------+  |                      |   |      $0.15 net          |    |
  |   |      ($0.15) net          |  |                      |   +-------------------------+    |
  |   +---------------------------+  |                      |                                  |
  |                                  |                      +----------------------------------+
  +----------------------------------+

```